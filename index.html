<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Posture Check</title>

  <!-- Fonts (optional) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0b0f1a;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.12);

      --ok-bg: #ecfdf3;         /* ì•ˆì •ì ì´ê³  í™˜í•œ í†¤ */
      --ok-text: #0a2a16;
      --warn-bg: #fff1f2;       /* ê²½ê³  í†¤ */
      --warn-text: #3b0a12;

      --accent: #7c3aed;
      --accent2: #22c55e;
      --accent3: #ef4444;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
    }

    /* Theme switching */
    html.theme-default { background: radial-gradient(1200px 800px at 20% 10%, rgba(124,58,237,.35), transparent 55%),
                                     radial-gradient(900px 700px at 80% 0%, rgba(34,197,94,.18), transparent 60%),
                                     var(--bg); }
    html.theme-ok      { background: radial-gradient(900px 700px at 20% 10%, rgba(34,197,94,.18), transparent 60%),
                                     var(--ok-bg); }
    html.theme-warn    { background: radial-gradient(900px 700px at 20% 10%, rgba(239,68,68,.18), transparent 60%),
                                     var(--warn-bg); }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", sans-serif;
      color: var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      transition: background-color .25s ease;
    }

    /* Text color adapts for ok/warn */
    html.theme-ok body, html.theme-warn body { color: #0b1220; }
    html.theme-ok .muted, html.theme-warn .muted { color: rgba(11,18,32,.65); }

    .wrap{
      width: min(980px, 100%);
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 18px;
    }
    @media (max-width: 860px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    html.theme-ok .card, html.theme-warn .card{
      background: rgba(255,255,255,.70);
      border-color: rgba(11,18,32,.10);
      box-shadow: 0 18px 50px rgba(11,18,32,.10);
    }

    .header{
      padding: 18px 18px 14px 18px;
      border-bottom: 1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
    }
    html.theme-ok .header, html.theme-warn .header{ border-bottom-color: rgba(11,18,32,.10); }

    .title{
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.02em;
      margin:0;
    }
    .muted{ color: var(--muted); font-size: 13px; line-height: 1.45; margin-top: 6px; }

    .controls{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.10);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 600;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    html.theme-ok .btn, html.theme-warn .btn{
      background: rgba(11,18,32,.06);
      color: #0b1220;
      border-color: rgba(11,18,32,.12);
    }

    .btn.primary{
      border-color: rgba(124,58,237,.55);
      background: linear-gradient(135deg, rgba(124,58,237,.85), rgba(99,102,241,.70));
    }
    .btn.primary:hover{ filter: brightness(1.04); }
    html.theme-ok .btn.primary, html.theme-warn .btn.primary{
      color: white;
      border-color: rgba(124,58,237,.0);
    }

    .content{
      padding: 18px;
      display:grid;
      gap: 14px;
    }

    /* Webcam frame */
    .frame{
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.25);
      overflow:hidden;
      position: relative;
      aspect-ratio: 1 / 1;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    html.theme-ok .frame, html.theme-warn .frame{
      background: rgba(11,18,32,.04);
      border-color: rgba(11,18,32,.10);
    }

    .frame canvas{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display:block;
    }

    /* Status pill */
    .status{
      position:absolute;
      left: 12px;
      top: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: .01em;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
    }
    html.theme-ok .status, html.theme-warn .status{
      border-color: rgba(11,18,32,.10);
      background: rgba(255,255,255,.75);
      color: #0b1220;
    }
    .status.ok{ outline: 2px solid rgba(34,197,94,.35); }
    .status.warn{ outline: 2px solid rgba(239,68,68,.35); }

    /* Right side: probability bars */
    .panel{
      padding: 18px;
      display:grid;
      gap: 12px;
    }
    .panel h3{
      margin:0;
      font-size: 14px;
      letter-spacing: -0.01em;
    }

    .bar{
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      overflow:hidden;
    }
    html.theme-ok .bar, html.theme-warn .bar{
      background: rgba(11,18,32,.06);
      border-color: rgba(11,18,32,.10);
    }
    .bar > .fill{
      height: 38px;
      width: 0%;
      background: linear-gradient(90deg, rgba(124,58,237,.85), rgba(99,102,241,.75));
      transition: width .18s ease;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 0 12px;
      gap: 10px;
      color: white;
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
    }
    .bar > .fill.okFill{
      background: linear-gradient(90deg, rgba(34,197,94,.85), rgba(16,185,129,.70));
    }
    .bar > .fill.warnFill{
      background: linear-gradient(90deg, rgba(239,68,68,.85), rgba(244,63,94,.70));
    }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
    }

    .footerNote{
      font-size: 11px;
      color: var(--muted);
      padding: 0 18px 18px 18px;
    }

    /* Minimal spinner */
    .spinner{
      width: 18px; height: 18px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,.35);
      border-top-color: rgba(255,255,255,.9);
      animation: spin .8s linear infinite;
    }
    html.theme-ok .spinner, html.theme-warn .spinner{
      border-color: rgba(11,18,32,.25);
      border-top-color: rgba(11,18,32,.75);
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Webcam -->
    <section class="card">
      <div class="header">
        <div>
          <h1 class="title">Teachable Machine Â· ìì„¸ ì²´í¬</h1>
          <div class="muted">ì¹´ë©”ë¼ë¥¼ ì¼œë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ë¥˜ ê²°ê³¼ê°€ í‘œì‹œë˜ê³ , 50% ê¸°ì¤€ìœ¼ë¡œ í™”ë©´ í…Œë§ˆê°€ ë°”ë€Œë©° 80% ì´ìƒì´ë©´ ì†Œë¦¬ ê²½ê³ ê°€ ìš¸ë¦½ë‹ˆë‹¤.</div>
        </div>
        <div class="controls">
          <button id="startBtn" class="btn primary" type="button" onclick="init()">
            <span id="startIcon">â–¶</span>
            <span id="startText">Start</span>
          </button>
          <button id="stopBtn" class="btn" type="button" onclick="stopCam()" disabled>
            â–  Stop
          </button>
        </div>
      </div>

      <div class="content">
        <div class="frame">
          <div id="statusPill" class="status">ëŒ€ê¸° ì¤‘</div>
          <div id="webcam-container"></div>
        </div>
        <div class="hint">
          * íŒ: ì¡°ëª…ì´ ë„ˆë¬´ ì–´ë‘ìš°ë©´ ì •í™•ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”. í™”ë©´ ì •ë©´, ìƒì²´ê°€ ì˜ ë³´ì´ë„ë¡ ë§ì¶°ì£¼ì„¸ìš”.
        </div>
      </div>
      <div class="footerNote">Â© Posture UI Â· Simple & Modern</div>
    </section>

    <!-- Right: Predictions -->
    <aside class="card">
      <div class="panel">
        <h3>ì˜ˆì¸¡ í™•ë¥ </h3>

        <!-- Bars will be generated dynamically -->
        <div id="label-container"></div>

        <div class="hint">
          â€¢ â€œë°”ë¥¸ìì„¸â€ í™•ë¥ ì´ 50% ì´ìƒì´ë©´ ì•ˆì •ì ì¸ ë°ì€ í…Œë§ˆ<br/>
          â€¢ â€œë‚˜ìœìì„¸â€ í™•ë¥ ì´ 50% ì´ìƒì´ë©´ ê²½ê³  í…Œë§ˆ<br/>
          â€¢ â€œë‚˜ìœìì„¸â€ í™•ë¥ ì´ 80% ì´ìƒì´ë©´ ì†Œë¦¬ ê²½ê³ (2ì´ˆ ì¿¨ë‹¤ìš´)
        </div>
      </div>
    </aside>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

  <script>
    // âœ… Your model
    const URL = "https://teachablemachine.withgoogle.com/models/WIFY29SSD/";

    let model, webcam, maxPredictions;
    let barRows = [];  // store DOM refs for each class row
    let loopRunning = false;

    // âœ… ê²½ê³  ì¤‘ë³µ ë°©ì§€ + ì˜¤ë””ì˜¤
    let warningShown = false;      // ê²½ê³ (íŒì—… ë“±) ì¤‘ë³µ ë°©ì§€ìš©
    let audioCtx = null;           // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸(ì‚¬ìš©ì í´ë¦­ í›„ ìƒì„±)
    let soundCooldownUntil = 0;    // ì†Œë¦¬ ë°˜ë³µ ë°©ì§€(ì¿¨ë‹¤ìš´)

    // ì§§ì€ ê²½ê³  ë¹„í”„ìŒ (Web Audio API)
    function beepWarning() {
      const now = Date.now();
      if (now < soundCooldownUntil) return; // ë„ˆë¬´ ìì£¼ ìš¸ë¦¬ì§€ ì•Šê²Œ

      // ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ìƒì„±/ì¬ê°œ(ì‚¬ìš©ì ì œìŠ¤ì²˜ ì´í›„ ê°€ëŠ¥)
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === "suspended") audioCtx.resume();

      const o1 = audioCtx.createOscillator();
      const g  = audioCtx.createGain();

      // "ì‚-ì‚" ë‘ ë²ˆ ìš¸ë¦¬ëŠ” ëŠë‚Œ
      const t = audioCtx.currentTime;

      o1.type = "sine";
      o1.frequency.setValueAtTime(880, t); // 880Hz
      g.gain.setValueAtTime(0.0001, t);

      // ì²« ë²ˆì§¸ ë¹„í”„
      g.gain.exponentialRampToValueAtTime(0.25, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);

      // ë‘ ë²ˆì§¸ ë¹„í”„ (ì¡°ê¸ˆ ë’¤)
      g.gain.exponentialRampToValueAtTime(0.25, t + 0.28);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.44);

      o1.connect(g);
      g.connect(audioCtx.destination);

      o1.start(t);
      o1.stop(t + 0.5);

      // 2ì´ˆ ì¿¨ë‹¤ìš´(ì›í•˜ë©´ ì¡°ì ˆ)
      soundCooldownUntil = now + 2000;
    }

    // theme helpers
    function setTheme(mode){ // 'default' | 'ok' | 'warn'
      const root = document.documentElement;
      root.classList.remove("theme-default","theme-ok","theme-warn");
      root.classList.add(`theme-${mode}`);
    }
    setTheme("default");

    function setStatus(text, type){ // type: 'default'|'ok'|'warn'
      const pill = document.getElementById("statusPill");
      pill.textContent = text;
      pill.classList.remove("ok","warn");
      if(type === "ok") pill.classList.add("ok");
      if(type === "warn") pill.classList.add("warn");
    }

    function setStartLoading(isLoading){
      const startBtn = document.getElementById("startBtn");
      const stopBtn  = document.getElementById("stopBtn");
      const startIcon = document.getElementById("startIcon");
      const startText = document.getElementById("startText");

      if(isLoading){
        startBtn.disabled = true;
        stopBtn.disabled = true;
        startIcon.innerHTML = '<span class="spinner" aria-hidden="true"></span>';
        startText.textContent = "Loadingâ€¦";
      }else{
        startBtn.disabled = loopRunning; // if running, keep disabled
        stopBtn.disabled  = !loopRunning;
        startIcon.textContent = "â–¶";
        startText.textContent = loopRunning ? "Running" : "Start";
      }
    }

    async function init() {
      try{
        setStartLoading(true);
        setStatus("ëª¨ë¸ ë¡œë”© ì¤‘â€¦", "default");

        // (ì„ íƒ) ì‚¬ìš©ì í´ë¦­ ì§í›„ ì˜¤ë””ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì¤€ë¹„ â†’ ì •ì±… ëŒ€ì‘
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === "suspended") await audioCtx.resume();

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        // webcam
        const flip = true;
        webcam = new tmImage.Webcam(420, 420, flip);
        await webcam.setup();
        await webcam.play();

        // mount canvas
        const wc = document.getElementById("webcam-container");
        wc.innerHTML = "";
        wc.appendChild(webcam.canvas);

        // build prediction bars UI
        buildBars();

        loopRunning = true;
        setStartLoading(false);
        setStatus("ì¸¡ì • ì¤‘â€¦", "default");
        window.requestAnimationFrame(loop);
      }catch(err){
        console.error(err);
        loopRunning = false;
        setStartLoading(false);
        setTheme("default");
        setStatus("ì¹´ë©”ë¼ ê¶Œí•œ/ëª¨ë¸ ë¡œë”© ì˜¤ë¥˜", "warn");
        alert("ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í–ˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.");
      }
    }

    function buildBars(){
      const labelContainer = document.getElementById("label-container");
      labelContainer.innerHTML = "";
      barRows = [];

      for(let i=0; i<maxPredictions; i++){
        const row = document.createElement("div");

        const bar = document.createElement("div");
        bar.className = "bar";

        const fill = document.createElement("div");
        fill.className = "fill";
        fill.style.width = "0%";
        fill.innerHTML = `<span class="name">Class</span><span class="pct">0%</span>`;

        bar.appendChild(fill);
        row.appendChild(bar);
        labelContainer.appendChild(row);

        barRows.push({ fill, nameEl: fill.querySelector(".name"), pctEl: fill.querySelector(".pct") });
      }
    }

    async function loop() {
      if(!loopRunning) return;
      webcam.update();
      await predict();
      window.requestAnimationFrame(loop);
    }

    function stopCam(){
      try{
        loopRunning = false;
        if(webcam){
          webcam.stop();
        }
        setTheme("default");
        setStatus("ì •ì§€ë¨", "default");

        // ìƒíƒœ ì´ˆê¸°í™”
        warningShown = false;
        soundCooldownUntil = 0;

        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        document.getElementById("startText").textContent = "Start";
      }catch(e){
        console.error(e);
      }
    }

    // âœ… className ë§¤ì¹­(â€˜ë°”ë¥¸ìì„¸â€™, â€˜ë‚˜ìœìì„¸â€™)ì„ ì •í™•íˆ ì°¾ê¸°
    function findProb(prediction, keywords){
      // keywords: string or array
      const keys = Array.isArray(keywords) ? keywords : [keywords];
      const found = prediction.find(p => keys.some(k => (p.className || "").includes(k)));
      return found ? found.probability : null;
    }

    async function predict() {
      const prediction = await model.predict(webcam.canvas);

      // update bars
      for (let i = 0; i < prediction.length; i++) {
        const p = prediction[i];
        const pct = Math.round(p.probability * 100);
        const row = barRows[i];

        row.nameEl.textContent = p.className;
        row.pctEl.textContent = `${pct}%`;
        row.fill.style.width = `${pct}%`;

        // give semantic color to likely classes (optional)
        row.fill.classList.remove("okFill","warnFill");
        if((p.className || "").includes("ë°”ë¥¸")) row.fill.classList.add("okFill");
        if((p.className || "").includes("ë‚˜ìœ")) row.fill.classList.add("warnFill");
      }

      // theme switching rule (50% ê¸°ì¤€)
      const good = findProb(prediction, ["ë°”ë¥¸ìì„¸","ë°”ë¥¸"]);
      const bad  = findProb(prediction, ["ë‚˜ìœìì„¸","ë‚˜ìœ","ë¶ˆëŸ‰","ê²½ê³ "]);

      // âœ… ë‚˜ìœìì„¸ 80% ì´ìƒì´ë©´ ì†Œë¦¬ ê²½ê³ (ì¿¨ë‹¤ìš´ ì ìš©)
      if (bad !== null && bad >= 0.8) {
        beepWarning(); // ğŸ”Š

        // (ì„ íƒ) íŒì—…ì´ í•„ìš”í•˜ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
        // if (!warningShown) {
        //   alert("âš ï¸ ìì„¸ê°€ ë§ì´ ííŠ¸ëŸ¬ì¡Œì–´ìš”!\ní—ˆë¦¬ë¥¼ í´ê³  ë°”ë¥¸ ìì„¸ë¡œ ì•‰ì•„ì£¼ì„¸ìš”.");
        //   warningShown = true;
        // }
      } else {
        // 80% ë¯¸ë§Œìœ¼ë¡œ ë‚´ë ¤ê°€ë©´ ë‹¤ì‹œ ê²½ê³  ê°€ëŠ¥ ìƒíƒœ(íŒì—…ì„ ì“¸ ê²½ìš°)
        warningShown = false;
      }

      // âœ… ë°°ê²½ í…Œë§ˆ ìš°ì„ ìˆœìœ„: bad 50% ì´ìƒì´ë©´ warn, else good 50% ì´ìƒì´ë©´ ok, else default
      if (bad !== null && bad > 0.5) {
        setTheme("warn");
        setStatus(`ë‚˜ìœìì„¸ ê°ì§€ Â· ${(bad*100).toFixed(0)}%`, "warn");
      } else if (good !== null && good > 0.5) {
        setTheme("ok");
        setStatus(`ë°”ë¥¸ìì„¸ Â· ${(good*100).toFixed(0)}%`, "ok");
      } else {
        setTheme("default");
        setStatus("ì¸¡ì • ì¤‘â€¦", "default");
      }
    }
  </script>
</body>
</html>
